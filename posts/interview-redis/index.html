<!DOCTYPE html>
<html lang="zh-CN">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://arloor.github.io/posts/interview-redis/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.135.0">

    
    
    

<title>面试：Redis • 八股文</title>
<meta name="description" content="今天，你学习了吗">
<meta name="keywords" content="刘港欢, arloor, moontell">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="面试：Redis">
  <meta name="twitter:description" content="今天，你学习了吗">
      <meta name="twitter:site" content="@njulgh">

<meta property="og:url" content="https://arloor.github.io/posts/interview-redis/">
  <meta property="og:site_name" content="八股文">
  <meta property="og:title" content="面试：Redis">
  <meta property="og:description" content="今天，你学习了吗">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-11-23T19:38:31+08:00">
    <meta property="article:modified_time" content="2022-11-23T19:38:31+08:00">
    <meta property="article:tag" content="Interview">


    





<link rel="stylesheet" href="/styles/atom-one-dark.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.484b96856b25751067d56c8c0af9dc1fd6372707029b6d56ee178da6bead45b5.css" integrity="sha256-SEuWhWsldRBn1WyMCvncH9Y3JwcCm21W7heNpr6tRbU=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.0873834b0f2e9fdc9e1d0301e8ebce21fc10383882a41e9373f29b90e85a9987.css" integrity="sha256-CHODSw8un9yeHQMB6OvOIfwQODiCpB6Tc/KbkOhamYc=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">
          
          八股文
          
        </a>
      </span>
      <a href="/">
        
        
        <div class="author-image">
          <img src="/img/head.jpeg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
        
      </a>
      
      <p class="site__description">
         今天，你学习了吗 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">八股文</label>
      <div class="menu-content">
        <div class="show-in-small">
          <a href="/">
            
            
            <div class="author-image">
              <img src="/img/head.jpeg" alt="Author Image"
                class="img--circle img--headshot element--center">
            </div>
            
            
          </a>
        </div>
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="https://www.arloor.com">
						<span>我的博客</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://x.com/njulgh" rel="me"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/popstary" rel="me"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
      </div>
    </div>
    
<div class="copyright">
  &copy; 2024 arloor
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/arloor/hyde-arloor">hyde-arloor</a>.
</div>


  </div>
</div>
        <div class="content container">
            
    
<article>
  <header>
    <h1>面试：Redis</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Nov 23, 2022
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/undefined">UNDEFINED</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/interview">interview</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 6 min read
</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle">
      <label for="tocToggle">Table of Content</label>
      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#缓存雪崩缓存击穿缓存穿透">缓存雪崩、缓存击穿、缓存穿透</a></li>
    <li><a href="#数据库和缓存双写导致的不一致问题">数据库和缓存双写，导致的不一致问题</a></li>
    <li><a href="#线程模型">线程模型</a></li>
    <li><a href="#redis的过期策略和内存淘汰策略">Redis的过期策略和内存淘汰策略</a></li>
    <li><a href="#lru最近最少使用-java实现">LRU最近最少使用 java实现</a></li>
    <li><a href="#高可用">高可用</a></li>
    <li><a href="#持久化">持久化</a>
      <ul>
        <li><a href="#rdb">RDB</a></li>
        <li><a href="#aof">AOF</a></li>
        <li><a href="#异步拷贝">异步拷贝</a></li>
      </ul>
    </li>
    <li><a href="#sentinel">sentinel</a>
      <ul>
        <li><a href="#模拟sentinel故障迁移过程">模拟sentinel故障迁移过程</a></li>
        <li><a href="#sdown事件和odown事件">SDOWN事件和ODOWN事件</a></li>
      </ul>
    </li>
    <li><a href="#集群模式">集群模式</a></li>
    <li><a href="#分布式寻址">分布式寻址</a></li>
  </ul>
</nav>
      
    </div>
  
  
  <div class="post">
    <h2 id="缓存雪崩缓存击穿缓存穿透">缓存雪崩、缓存击穿、缓存穿透</h2>
<p>讨厌命名党，明明是很简单的几种情况</p>
<ul>
<li>缓存雪崩：redis中大量key在短时间失效，导致集中查询mysql，mysql压力突增。</li>
<li>缓存击穿：某个热点key，突然失效，导致该key上的几千qps打到mysql上。</li>
<li>缓存穿透：大量请求redis中不存在的key，导致向mysql中请求这些数据。多发于非法的参数。</li>
</ul>
<h2 id="数据库和缓存双写导致的不一致问题">数据库和缓存双写，导致的不一致问题</h2>
<p>偏业务，不看</p>
<h2 id="线程模型">线程模型</h2>
<ul>
<li>命令执行（get、set以及hash计算等）使用单线程</li>
<li>网络处理、报文解析：5.0以前也是单线程，6.0以后多线程</li>
</ul>
<p>redis处理socket连接采用IO多路复用，即单线程处理多个FD，FD可读、可写时再进行处理。</p>
<p>单线程的好处是没有线程切换的损耗，以及避免加锁</p>
<p>但是对于大value，网络io将会占用大量cpu时间，单线程就会导致cpu在io上等待，所以6.0开始有多线程。</p>
<h2 id="redis的过期策略和内存淘汰策略">Redis的过期策略和内存淘汰策略</h2>
<p>过期策略：</p>
<ul>
<li>定时过期：每隔一段时间扫描expire字典中的若干个（不是全部）key，若过期则删除。并不扫描全部，避免过高的cpu负载</li>
<li>惰性删除：已过期的key在访问到时进行过期。</li>
</ul>
<p>过期策略针对的是设置了expire时间的key，redis还支持不过期。针对不过期的key，以及定时过期没扫描到的key，redis也有内存淘汰机制，防止撑爆内存。</p>
<p>内存淘汰机制：</p>
<ul>
<li>noeviction：当内存不足以容纳新写入数据时，新写入操作会报错。</li>
<li>allkeys-lru：当内存不足以容纳新写入数据时，在键空间中，移除最近最少使用的key。</li>
<li>allkeys-random：当内存不足以容纳新写入数据时，在键空间中，随机移除某个key。</li>
<li>volatile-lru：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，移除最近最少使用的key。</li>
<li>volatile-random：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，随机移除某个key。</li>
<li>volatile-ttl：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，有更早过期时间的key优先移除。</li>
</ul>
<h2 id="lru最近最少使用-java实现">LRU最近最少使用 java实现</h2>
<p>使用HashMap+LinkedList实现</p>
<ul>
<li>LinkedList实现双端队列，保存使用顺序</li>
<li>HashMap保存索引，即key是否存在</li>
</ul>
<h2 id="高可用">高可用</h2>
<p>高可用涉及到的点有：</p>
<ul>
<li>持久化</li>
<li>主从复制</li>
<li>sentinel（哨兵模式）</li>
<li>redis集群模式</li>
</ul>
<p>这些主题有一些演进关系，例如，主从复制用的是持久化的aof/rdb，sentinel又依赖于主从复制，redis集群则是抛弃了哨兵的高可用方案。接下来就按照这个顺序来看。</p>
<h2 id="持久化">持久化</h2>
<h3 id="rdb">RDB</h3>
<ul>
<li>使用SAVE， BGSAVE命令来定时地快照</li>
<li>BGSAVE使用fork来创建子进程，利用copy-on-write的机制，只有脏页才会新增内存占用，共用未变更的内存。</li>
<li>因为是快照，所以更加紧凑</li>
<li>因为是定时执行，所以可能丢失部分数据</li>
</ul>
<h3 id="aof">AOF</h3>
<ul>
<li>尾部追加</li>
<li>在网络IO线程接收到RESP协议的指令后面，处理流程的最后会进行写AOF</li>
<li>写AOF的过程不仅是写到文件，也会写到slave</li>
<li>当AOF文件过大时，会进行rewrite，也就是将生成RDB，替换头部的操作记录。</li>
</ul>
<h3 id="异步拷贝">异步拷贝</h3>
<ol>
<li>调用SLAVEOF或CLUSTER REPLICATE命令，获取master的ip、port</li>
<li>redis的定时任务创建到master的tcp连接（在发现没有有效连接的情况下）</li>
<li>通过该tcp连接发送PING AUTH REPLCONF等指令，完成与master的握手</li>
<li>如果是第一次拿拷贝，没有runid 和offset，转到5。如果不是第一次拿拷贝，则转到6</li>
<li>发送PSYNC ? -1，接收master的rdb格式的全量同步数据、runid 和offset。rdb接收完毕后，redis加载rdb文件，而后转到7</li>
<li>发送PSYNC runid offset，收到+CONTINUE runid，表示主节点继续“增量”地发送异步拷贝信息 ，转到7。（PS：这里仅覆盖runid和offset有效的情况，关于有效性和无效时的表现在《主节点PSYNC实现》有叙）</li>
<li>主节点会不断发送自己收到的写请求的tcp报文，从节点执行这些写请求，并增加offset。直到该tcp连接异常断开，转到2（定时任务创建新的连接）</li>
</ol>
<p><strong>备份积压缓冲区</strong></p>
<p>因为是异步拷贝，那么master和slave之间肯定存在一定的偏差。备份积压缓冲区就是保存这个offset里的数据。如果异步拷贝的时候offset大于这个阈值，psync的追加将会失败，需要重新同步完整的RDB。</p>
<blockquote>
<p>考虑：考虑来不及主从复制，一直超出这个备份积压缓冲区，那么一直会触发RDB，对系统的压力会很高。</p>
</blockquote>
<h2 id="sentinel">sentinel</h2>
<p>sentinel是redis官方高可用方案，从宏观角度看，sentinel提供以下能力。</p>
<ul>
<li>监控： 持续检测主从节点是否正常工作</li>
<li>通知： sentinel可以通过调用notification_script向系统管理员报告事件</li>
<li>自动故障转移： 如果主节点不能正常工作，sentinel会提升其他从节点为主节点，并通知客户端新主节点的地址。</li>
<li>配置提供：告知客户端主节点的地址</li>
</ul>
<h3 id="模拟sentinel故障迁移过程">模拟sentinel故障迁移过程</h3>
<p>使用<code>redis-cli -p 6379 DEBUG sleep 30</code>模拟主节点宕机三十秒。会出现以下过程</p>
<ol>
<li>每个sentinel都判定该主节点为+sdown（主观宕机）</li>
<li>最终该主观宕机被确认为+odown（客观宕机）——多个sentinel判定其为主观宕机</li>
<li>一个sentinel被大部分sentinel投票来执行故障迁移</li>
<li>该sentinel执行故障迁移</li>
</ol>
<h3 id="sdown事件和odown事件">SDOWN事件和ODOWN事件</h3>
<p>SDOWN是主观宕机，即sentinel自己认为某master宕机。<br>
ODWON是客观宕机，即大于等于quorum个sentinel都认为该master宕机——此时才可故障。</p>
<p>在sentinel向master发送PING后，超过<code>is-master-down-after-milliseconds</code>毫秒仍未收到有效的响应（+PONG、-LOADING、-MASTERDOWN），则sentinel记录master的状态为SDOWN。</p>
<p>从SDOWN到ODOWN状态的转换没有使用强一致性协议，而是一种gossip（流言蜚语）协议——只要一个sentinel被足够数量的sentinel告知master处于SDOWN，则该sentinel标记其为ODOWN，并开始选举从而执行故障迁移。</p>
<p>ODOWN只适用于master，而slave和sentinel节点还有SDOWN状态。<strong>被标记为SDOWN的从节点不会被选举为主节点。</strong></p>
<h2 id="集群模式">集群模式</h2>
<p>分布到16384个slot中，再分配到不同的node中（二次分桶）</p>
<p>gossip协议</p>
<p>PFAIL、FAIL</p>
<p>currentEpoch：执行故障迁移时+1</p>
<p>configEpoch： 用于标记slot分布、主从关系的version，用于网路分区后老主节点恢复连接后的处理</p>
<p><a href="https://www.arloor.com/posts/redis/redis-cluster/">https://www.arloor.com/posts/redis/redis-cluster/</a></p>
<h2 id="分布式寻址">分布式寻址</h2>
<p><strong>Hash</strong></p>
<p>hash算到一个桶</p>
<p>问题是有worker下线时，hash结果会大量迁移</p>
<p><strong>一致性Hash</strong></p>
<p>将workers计算hash，放置在hash环中，并增加虚拟节点（用多种方式计算hash）。</p>
<p>将task也计算hash，顺时针在hash环中寻找下一节点。</p>
<p><strong>二次分桶</strong></p>
<p>像redis一样，先hash到16384个slot，再将这些slot分布到不同的node</p>
  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/interview-mysql/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">面试：Mysql</span>
    </a>
    
    
    <a href="/posts/interview-socket/" class="navigation-next">
      <span class="navigation-tittle">面试：网络/IO</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  


</article>


        </div>
        
    



<script defer src="/js/all.js" crossorigin="anonymous"></script>

    
    
    <script src="/js/highlight.min.js"></script>
    <script src="/js/languages/dos.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.highlightAll();
    </script>
    




    



    </body>
</html>
